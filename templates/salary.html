<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Requests</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/admin_home.css" />
    <link rel="stylesheet" href="../static/salary.css" />
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body>

    <div class="image">

        <h1 id="mobile">Welcome Back , <br> Admin {{username}}</h1>
        <h1 id="dekstop">Welcome Back , Admin {{username}}</h1>
        <div class="burger-icon open" id="burgerIcon">&#9776;</div>
        <div class="burger-icon close" id="burgerIconClose">&#10006;</div>
        <a href="/logout" class="logout-btn">Logout</a>
    </div>
    <div class="sidebar" id="sidebar">
        <div class="baselogo">
          <div class="logonew-icon">
            <i class="fa-solid fa-wand-sparkles"></i>
          </div>
          <h2>Admin Dashboard</h2>
        </div>
        <div class="cover_of_sidebar_links">
          <a href="{{url_for('admin_home')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="users"
              class="lucide lucide-users"
            >
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Dashboard
          </div>
        </a>
        <a href="{{url_for('employee_details')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="user"
              class="lucide lucide-user"
            >
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Employee Management
          </div>
        </a>
        <a href="{{url_for('tasks')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="clipboard-list"
              class="lucide lucide-clipboard-list"
            >
              <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
              <path
                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
              ></path>
              <path d="M12 11h4"></path>
              <path d="M12 16h4"></path>
              <path d="M8 11h.01"></path>
              <path d="M8 16h.01"></path>
            </svg>
           Task Tracking
          </div>
        </a>
        <a href="{{ url_for('admin_leave_requests') }}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="calendar"
              class="lucide lucide-calendar"
            >
              <path d="M8 2v4"></path>
              <path d="M16 2v4"></path>
              <rect width="18" height="18" x="3" y="4" rx="2"></rect>
              <path d="M3 10h18"></path>
            </svg>
            Leave Requests
          </div>
        </a>
        <a href="{{url_for('performance')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="bar-chart-2"
              class="lucide lucide-bar-chart-2"
            >
              <line x1="18" x2="18" y1="20" y2="10"></line>
              <line x1="12" x2="12" y1="20" y2="4"></line>
              <line x1="6" x2="6" y1="20" y2="14"></line>
            </svg>
           Performance Reviews
          </div>
        </a>
        <a href="{{url_for('salary')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="file-text"
              class="lucide lucide-file-text"
            >
              <path
                d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"
              ></path>
              <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
              <path d="M10 9H8"></path>
              <path d="M16 13H8"></path>
              <path d="M16 17H8"></path>
            </svg>
            Salary Management
          </div>
        </a>
        <a href="{{url_for('admin_complaints')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              data-lucide="clipboard-list"
              class="lucide lucide-clipboard-list"
            >
              <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
              <path
                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
              ></path>
              <path d="M12 11h4"></path>
              <path d="M12 16h4"></path>
              <path d="M8 11h.01"></path>
              <path d="M8 16h.01"></path>
            </svg>
            Employee Reviews
          </div>
        </a>
        </div>
      </div>



        <div class="dashboard-content">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fa-solid fa-money-bill-wave"></i>
                        <span>Salary Management</span>
                    </h2>
                </div>
                <div class="section-content">
                    <div class="cards-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon card-icon-purple">
                                    <i class="fa-solid fa-user-tie"></i>
                                </div>
                            </div>
                            <h3 class="card-title">Employee Salary</h3>
                            <p class="card-description">View and update employee salary details</p>
                            <div class="card-footer">
                                <form id="salaryForm">
                                    <div class="form-group">
                                        <label for="employeeSelect">Select Employee:</label>
                                        <select id="employeeSelect" class="form-control" required>
                                            <option value="">-- Select Employee --</option>
                                            {% for emp in employees %}
                                            <option value="{{ emp.email }}" data-current="{{ emp.salary|default(0) }}">{{ emp.username }} ({{ emp.email }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="currentSalary">Current Salary:</label>
                                        <input type="text" id="currentSalary" class="form-control" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="newSalary">New Salary:</label>
                                        <input type="number" id="newSalary" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="incrementReason">Increment Reason:</label>
                                        <textarea id="incrementReason" class="form-control" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="card-button card-button-purple">
                                        <span>Update Salary</span>
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

<div class="card">
    <div class="card-header">
        <div class="card-icon card-icon-emerald">
            <i class="fa-solid fa-file-invoice-dollar"></i>
        </div>
    </div>
    <h3 class="card-title">Generate Salary Slip</h3>
    <p class="card-description">Create and download salary slips for employees</p>
    <div class="card-footer">
        <form id="slipForm">
            <!-- Employee Info Display (now above the select) -->
            <div id="employeeInfo" class="employee-info-display" style="display: none;">
                <div class="employee-profile-container">
                    <div class="profile-pic-wrapper">
                        <img id="infoProfilePic" class="employee-profile-pic" 
                             onerror="this.src='/static/images/default-image.jpg';this.onerror=null;" 
                             src="" alt="Profile Picture">
                    </div>
                    <div class="employee-details">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span id="infoName" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Department:</span>
                            <span id="infoDepartment" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Current Salary:</span>
                            <span id="infoSalary" class="info-value"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="slipEmployee">Select Employee:</label>
                <select id="slipEmployee" class="form-control" required>
                    <option value="">-- Select Employee --</option>
                    {% for emp in employees %}
                    <option value="{{ emp.email }}" 
                            data-name="{{ emp.username }}"
                            data-salary="{{ emp.salary|default(0) }}"
                            data-department="{{ emp.department|default('N/A') }}"
                            data-profilepic="{{ emp.profile_image if emp.profile_image else '/static/images/default-image.jpg' }}">
                        {{ emp.username }} ({{ emp.email }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="monthYear">Month/Year:</label>
                <input type="month" id="monthYear" class="form-control" required>
            </div>
            <button type="submit" class="card-button card-button-emerald">
                <span>Generate Slip</span>
                <i class="fa-solid fa-download"></i>
            </button>
        </form>
    </div>
</div>
                    </div>

                    <div class="section" style="margin-top: 30px;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fa-solid fa-clock-rotate-left"></i>
                                <span>Salary History</span>
                            </h2>
                        </div>
                        <div class="section-content">
                            <div class="table-container">
                                <table class="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Email</th>
                                            <th>Previous Salary</th>
                                            <th>New Salary</th>
                                            <th>Date</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for history in salary_history %}
                                        <tr>
                                            <td>{{ history.employee_name }}</td>
                                            <td>{{ history.employee_email }}</td>
                                            <td>₹{{ history.previous_salary }}</td>
                                            <td>₹{{ history.new_salary }}</td>
                                            <td>{{ history.date.strftime('%d-%m-%Y') }}</td>
                                            <td>{{ history.reason }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('employeeSelect').addEventListener('change', function() {
            const currentSalary = this.options[this.selectedIndex].getAttribute('data-current');
            document.getElementById('currentSalary').value = currentSalary ? '₹' + currentSalary : '₹0';
            document.getElementById('newSalary').value = currentSalary || '';
        });

       document.getElementById('salaryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const employeeEmail = document.getElementById('employeeSelect').value;
    const newSalary = document.getElementById('newSalary').value;
    const reason = document.getElementById('incrementReason').value;

    // Basic validation
    if (!employeeEmail || !newSalary) {
        alert('Please select an employee and enter a new salary');
        return;
    }

    try {
        const response = await fetch('/update_salary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                employee_email: employeeEmail,
                new_salary: newSalary,
                reason: reason
            })
        });

        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to update salary');
        }

        alert('Salary updated successfully!');
        window.location.reload();
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    }
});

        document.getElementById('slipForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeEmail = document.getElementById('slipEmployee').value;
            const monthYear = document.getElementById('monthYear').value;
            
            window.location.href = `/generate_salary_slip?email=${employeeEmail}&month=${monthYear}`;
        });
    document.getElementById('slipEmployee').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const infoDiv = document.getElementById('employeeInfo');
    
    if (this.value) {
        document.getElementById('infoName').textContent = selectedOption.getAttribute('data-name');
        document.getElementById('infoDepartment').textContent = selectedOption.getAttribute('data-department');
        document.getElementById('infoSalary').textContent = '₹' + selectedOption.getAttribute('data-salary');
        
        // Set profile picture with default fallback
        const profilePic = document.getElementById('infoProfilePic');
        const profilePicUrl = selectedOption.getAttribute('data-profilepic');
        profilePic.src = profilePicUrl || '/static/images/default-image.jpg';
        
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
});
    </script>
</body>
</html>
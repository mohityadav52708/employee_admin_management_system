<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Attendance</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/employee_attendance.css" />

    <style></style>
  </head>
  <body>
    <div class="image">
      <h1 id="dekstop">Welcome Back, {{username}}</h1>
      <div class="burger-icon open" id="burgerIcon">&#9776;</div>
      <div class="burger-icon close" id="burgerIconClose">&#10006;</div>

      <!-- Search Bar -->
      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Search tasks, leaves, reviews..."
        />
        <button class="search-btn"><i class="fa-solid fa-search"></i></button>
      </div>

      <div class="profile-section">
        <img
          src="{{ user.profile_image if user.profile_image else url_for('static', filename='default-profile.png') }}"
          alt="Profile Image"
          class="profile-img"
        />
      </div>
        <a href="/logout" class="logout-btn"
        ><i class="fa-solid fa-right-from-bracket"></i>&nbsp;Logout</a
        >
    </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="baselogo">
        <div class="logonew-icon">
          <i class="fa-solid fa-user-shield"></i>
        </div>
        <h2>Employee Dashboard</h2>
      </div>
      <div class="cover_of_sidebar_links">
        <a href="{{url_for('home')}}">
          <div class="sidelink ">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-home"
            >
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
          </div>
        </a>
        <a href="{{ url_for('profile') }}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-user"
            >
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Profile
          </div>
        </a>
        <a href="{{url_for('tasks')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-clipboard-list"
            >
              <rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect>
              <path
                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
              ></path>
              <path d="M12 11h4"></path>
              <path d="M12 16h4"></path>
              <path d="M8 11h.01"></path>
              <path d="M8 16h.01"></path>
            </svg>
            Task Management
          </div>
        </a>
        <a href="{{ url_for('request_leave') }}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-calendar"
            >
              <path d="M8 2v4"></path>
              <path d="M16 2v4"></path>
              <rect width="18" height="18" x="3" y="4" rx="2"></rect>
              <path d="M3 10h18"></path>
            </svg>
            Leave Management
          </div>
        </a>
        <a href="{{url_for('employee_salary')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-wallet"
            >
              <path d="M2 9.5V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v3.5"></path>
              <path d="M2 14.5V18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-3.5"></path>
              <path d="M2 9.5h20v5H2z"></path>
              <circle cx="17" cy="12" r="1"></circle>
            </svg>

            My Salary
          </div>
        </a>
        <a href="{{url_for('employee_attendance')}}">
          <div class="sidelink nav-item active">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-clock"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Attendance
          </div>
        </a>
        <a href="{{url_for('complaints')}}">
          <div class="sidelink">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-message-square"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            Reviews
          </div>
        </a>
      </div>
    </div>
    <div class="container py-4">
      <div class="cover_attendance">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">My Attendance</h1>
        </div>

        <!-- Current Status Card -->
        <div class="card attendance-card card-primary">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="card-title">Today's Attendance</h5>
                <p class="card-text">{{ today }}</p>

                {% if today_record %}
                <div class="d-flex align-items-center mb-2">
                  <span class="me-2">Status:</span>
                  <span
                    class="status-badge {% if today_record.status == 'Present' %}badge-present {% elif today_record.status == 'Completed' %}badge-completed {% elif today_record.status == 'Leave' %}badge-leave {% else %}badge-absent{% endif %}"
                  >
                    {{ today_record.status }}
                  </span>
                </div>

                {% if today_record.check_in %}
                <div class="mb-2">
                  <span class="me-2">Check-in:</span>
                  <span class="time-display">
                    {{ today_record.check_in.strftime('%H:%M:%S') if
                    today_record.check_in else '--:--:--' }}
                  </span>
                </div>
                {% endif %} {% if today_record.check_out %}
                <div class="mb-2">
                  <span class="me-2">Check-out:</span>
                  <span class="time-display">
                    {{ today_record.check_out.strftime('%H:%M:%S') if
                    today_record.check_out else '--:--:--' }}
                  </span>
                </div>
                <div>
                  <span class="me-2">Duration:</span>
                  <span class="time-display">
                    {{ today_record.duration if today_record.duration else 'N/A'
                    }}
                  </span>
                </div>
                {% endif %} {% else %}
                <p class="text-warning">No attendance recorded for today</p>
                {% endif %}
              </div>
              <div class="col-md-6 text-center">
                {% if today_record and today_record.check_in and not
                today_record.check_out %}
                <button
                  id="checkout-btn"
                  class="attendance-btn checkout-btn"
                  onclick="markAttendance()"
                >
                  <i class="fas fa-sign-out-alt me-2"></i>Check Out
                </button>
                {% elif today_record and today_record.check_out %}
                <p class="text-succes">Attendance completed for today</p>
                {% else %}
                <button
                  id="checkin-btn"
                  class="attendance-btn checkin-btn"
                  onclick="markAttendance()"
                >
                  <i class="fas fa-sign-in-alt me-2"></i>Check In
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
          <div class="col-md-3 mb-3">
            <div class="card attendance-card card-success h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title">Present Days</h6>
                    <h2 class="mb-0">{{ present_days }}</h2>
                  </div>
                  <div class="bg-white rounded-circle p-3">
                    <i class="fas fa-check-circle text-success fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card attendance-card card-danger h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title">Absent Days</h6>
                    <h2 class="mb-0">{{ absent_days }}</h2>
                  </div>
                  <div class="bg-white rounded-circle p-3">
                    <i class="fas fa-times-circle text-danger fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card attendance-card card-warning h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title">Leave Days</h6>
                    <h2 class="mb-0">{{ leave_days }}</h2>
                  </div>
                  <div class="bg-white rounded-circle p-3">
                    <i class="fas fa-umbrella-beach text-warning fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="card attendance-card h-100"
              style="
                background: linear-gradient(135deg, #9b59b6, #8e44ad);
                color: white;
              "
            >
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="card-title">Attendance %</h6>
                    <h2 class="mb-0">{{ attendance_percentage }}%</h2>
                  </div>
                  <div class="bg-white rounded-circle p-3">
                    <i class="fas fa-percentage text-purple fa-2x"></i>
                  </div>
                </div>
                <div class="progress mt-2">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: {{ attendance_percentage }}%"
                    aria-valuenow="{{ attendance_percentage }}"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-8 mb-4">
            <div class="card attendance-card h-100">
              <div
                class="card-header bg-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">Monthly Attendance Overview</h5>
                <div class="dropdown">
                  <button
                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    type="button"
                    id="chartDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    This Month
                  </button>
                  <ul
                    class="dropdown-menu dropdown-menu-end"
                    aria-labelledby="chartDropdown"
                  >
                    <li>
                      <a
                        class="dropdown-item active"
                        href="#"
                        data-period="month"
                        >This Month</a
                      >
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" data-period="quarter"
                        >This Quarter</a
                      >
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" data-period="year"
                        >This Year</a
                      >
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="attendanceChart"></canvas>
                </div>
                <div class="chart-legend" id="attendanceChartLegend"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4">
            <div class="card attendance-card h-100">
              <div class="card-header bg-white">
                <h5 class="mb-0">Employee Status</h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="employeeStatusChart"></canvas>
                </div>
                <div class="chart-legend" id="employeeStatusLegend"></div>
              </div>
            </div>
          </div>
        </div>
      
      <!-- Attendance History -->
      <div class="card attendance-card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Attendance History (Last 30 Days)</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover attendance-table mb-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>Duration</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for record in history %}
                <tr>
                  <td>{{ record.date }}</td>
                  <td>{{ record.date | datetimeformat('%A') }}</td>
                  <td>
                    {% if record.check_in_str %}{{ record.check_in_str }}{% else
                    %}--:--:--{% endif %}
                  </td>
                  <td>
                    {% if record.check_out_str %}{{ record.check_out_str }}{%
                    else %}--:--:--{% endif %}
                  </td>
                  <td>
                    {% if record.duration %}{{ record.duration }}{% else %}N/A{%
                    endif %}
                  </td>
                  <td>
                    <span
                      class="status-badge {% if record.status == 'Present' %}badge-present {% elif record.status == 'Completed' %}badge-completed {% elif record.status == 'Leave' %}badge-leave {% elif record.status == 'Online' %}badge-online {% elif record.status == 'Offline' %}badge-offline {% else %}badge-absent{% endif %}"
                    >
                      {{ record.status }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      </div>
      
    </div>

    <!-- Toast Notification -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div
        id="responseToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Attendance System</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const burgerIcon = document.getElementById("burgerIcon");
      const burgerIconClose = document.getElementById("burgerIconClose");
      const sidebar = document.getElementById("sidebar");

      burgerIcon.addEventListener("click", () => {
        sidebar.classList.add("show");
        burgerIcon.style.display = "none";
        burgerIconClose.style.display = "block";
      });

      burgerIconClose.addEventListener("click", () => {
        sidebar.classList.remove("show");
        burgerIcon.style.display = "block";
        burgerIconClose.style.display = "none";
      });

      // Notification dropdown toggle
      function toggleDropdown(id) {
        const dropdown = document.getElementById(id);
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }
      // Initialize toast
      const toastEl = document.getElementById("responseToast");
      const toast = new bootstrap.Toast(toastEl);

      function markAttendance() {
        fetch("/attendance/mark", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              // Update UI based on action
              const toastMessage = document.getElementById("toastMessage");
              toastMessage.textContent = data.message;
              toast.show();

              // Reload page after 2 seconds to show updated data
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              document.getElementById("toastMessage").textContent =
                data.message;
              toast.show();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("toastMessage").textContent =
              "An error occurred. Please try again.";
            toast.show();
          });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
      // [Previous JavaScript remains the same until the charts section]

      // Professional Attendance Chart
      const ctx = document.getElementById("attendanceChart").getContext("2d");
      const attendanceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Week 1", "Week 2", "Week 3", "Week 4"],
          datasets: [
            {
              label: "Present",
              data: [5, 4, 5, 3],
              backgroundColor: "rgba(76, 201, 240, 0.7)",
              borderColor: "rgba(76, 201, 240, 1)",
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.7,
            },
            {
              label: "Absent",
              data: [0, 1, 0, 2],
              backgroundColor: "rgba(247, 37, 133, 0.7)",
              borderColor: "rgba(247, 37, 133, 1)",
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.7,
            },
            {
              label: "Leave",
              data: [0, 0, 0, 0],
              backgroundColor: "rgba(248, 150, 30, 0.7)",
              borderColor: "rgba(248, 150, 30, 1)",
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.7,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: false,
              grid: {
                display: false,
                drawBorder: false,
              },
              ticks: {
                color: "#6c757d",
              },
            },
            y: {
              stacked: false,
              beginAtZero: true,
              max: 5,
              ticks: {
                stepSize: 1,
                color: "#6c757d",
              },
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
                drawBorder: false,
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: "#ffffff",
              titleColor: "#212529",
              bodyColor: "#6c757d",
              borderColor: "rgba(0, 0, 0, 0.1)",
              borderWidth: 1,
              padding: 12,
              usePointStyle: true,
              callbacks: {
                label: function (context) {
                  return `${context.dataset.label}: ${context.raw}`;
                },
              },
            },
          },
          interaction: {
            intersect: false,
            mode: "index",
          },
        },
      });

      // Create custom legend for attendance chart
      const attendanceChartLegend = document.getElementById(
        "attendanceChartLegend"
      );
      attendanceChart.data.datasets.forEach((dataset) => {
        const legendItem = document.createElement("div");
        legendItem.className = "chart-legend-item";

        const colorBox = document.createElement("div");
        colorBox.className = "chart-legend-color";
        colorBox.style.backgroundColor = dataset.backgroundColor;
        colorBox.style.border = `1px solid ${dataset.borderColor}`;

        const label = document.createElement("span");
        label.textContent = dataset.label;

        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        attendanceChartLegend.appendChild(legendItem);
      });

      // Employee Status Chart (Doughnut)
      const employeeStatusCtx = document
        .getElementById("employeeStatusChart")
        .getContext("2d");
      const employeeStatusChart = new Chart(employeeStatusCtx, {
        type: "doughnut",
        data: {
          labels: ["Online", "Offline", "On Leave"],
          datasets: [
            {
              data: [12, 5, 3],
              backgroundColor: [
                "rgba(76, 201, 240, 0.8)",
                "rgba(173, 181, 189, 0.8)",
                "rgba(248, 150, 30, 0.8)",
              ],
              borderColor: [
                "rgba(76, 201, 240, 1)",
                "rgba(173, 181, 189, 1)",
                "rgba(248, 150, 30, 1)",
              ],
              borderWidth: 1,
              cutout: "75%",
              radius: "90%",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: "#ffffff",
              titleColor: "#212529",
              bodyColor: "#6c757d",
              borderColor: "rgba(0, 0, 0, 0.1)",
              borderWidth: 1,
              padding: 12,
              usePointStyle: true,
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                },
              },
            },
          },
          cutout: "70%",
        },
      });

      // Create custom legend for employee status chart
      const employeeStatusLegend = document.getElementById(
        "employeeStatusLegend"
      );
      employeeStatusChart.data.datasets[0].data.forEach((value, index) => {
        const legendItem = document.createElement("div");
        legendItem.className = "chart-legend-item";

        const colorBox = document.createElement("div");
        colorBox.className = "chart-legend-color";
        colorBox.style.backgroundColor =
          employeeStatusChart.data.datasets[0].backgroundColor[index];
        colorBox.style.border = `1px solid ${employeeStatusChart.data.datasets[0].borderColor[index]}`;

        const label = document.createElement("span");
        label.textContent = `${employeeStatusChart.data.labels[index]}: ${value}`;

        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        employeeStatusLegend.appendChild(legendItem);
      });
const burgerIcon = document.getElementById('burgerIcon');
      const burgerIconClose = document.getElementById('burgerIconClose');
      const sidebar = document.getElementById('sidebar');
      burgerIcon.addEventListener('click', () => {
        sidebar.classList.add('show');
        burgerIcon.style.display = 'none';
        burgerIconClose.style.display = 'block';
      });
      burgerIconClose.addEventListener('click', () => {
        sidebar.classList.remove('show');
        burgerIcon.style.display = 'block';
        burgerIconClose.style.display = 'none';
      });
      // [Rest of the JavaScript remains the same]
    </script>
  </body>
</html>
